<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visualization Dashboard - ABCD Demo</title>
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151a36;
            --text-primary: #e4e7f1;
            --text-secondary: #a8b2d1;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --border-color: #2d3561;
            --shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        /* File Upload Section */
        .upload-section {
            background-color: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .file-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .file-upload-input {
            opacity: 0;
            position: absolute;
            z-index: 10;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-button {
            background-color: var(--accent-blue);
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .file-upload-button:hover {
            background-color: #2563eb;
        }

        .upload-success, .error-message, .warning-message {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }

        .upload-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .warning-message {
            background-color: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        /* Data Preview Section */
        .data-preview-section {
            background-color: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            display: none;
        }

        .data-preview {
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        .data-preview table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-preview th,
        .data-preview td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-preview th {
            background-color: var(--bg-primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Controls Section */
        .controls-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .control-panel {
            background-color: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .control-panel h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .control-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        select, input[type="text"], input[type="color"] {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        button {
            background-color: var(--accent-blue);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        button:hover {
            background-color: #2563eb;
        }

        button:disabled {
            background-color: var(--text-muted);
            cursor: not-allowed;
        }

        /* Chart Section */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background-color: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .remove-chart {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: var(--accent-red);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        /* Mobile Controls */
        .mobile-controls {
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .controls-section {
                grid-template-columns: 1fr;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .chart-container {
                padding: 1rem;
            }

            .chart-wrapper {
                height: 300px;
            }

            .mobile-controls {
                display: block;
                background-color: var(--bg-secondary);
                padding: 1rem;
                border-radius: 12px;
                margin-bottom: 1rem;
            }

            .data-preview {
                font-size: 0.875rem;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }

            .chart-wrapper {
                height: 250px;
            }
        }

        /* Accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <a href="/" title="Go to index page" style="display: block; padding: 1rem 2rem; color: var(--accent-blue); text-decoration: none;">← Back to Home</a>
    <div class="container">
        <h1>Data Visualization Dashboard</h1>
        
        <!-- File Upload Section -->
        <div class="upload-section">
            <div class="file-upload" data-cy="file-upload">
                <input 
                    type="file" 
                    id="file-upload-input" 
                    class="file-upload-input"
                    data-cy="file-upload-input" 
                    accept=".csv"
                    aria-describedby="file-upload-desc"
                    style="position: relative; z-index: 20;"
                >
                <label for="file-upload-input">
                    <button 
                        class="file-upload-button" 
                        data-cy="file-upload-button"
                        aria-label="Upload CSV file"
                        onclick="document.getElementById('file-upload-input').click()"
                    >
                        Upload CSV
                    </button>
                </label>
                <p id="file-upload-desc" class="visually-hidden">Upload a CSV file to visualize your data</p>
                <p data-cy="file-size-info" style="color: var(--text-muted); font-size: 0.875rem;">Maximum file size: 10MB</p>
            </div>
            <div class="upload-success" data-cy="upload-success">File uploaded successfully!</div>
            <div class="error-message" data-cy="error-message"></div>
            <div class="warning-message" data-cy="warning-message"></div>
        </div>

        <!-- Data Preview Section -->
        <div class="data-preview-section" data-cy="data-preview-container">
            <h2>Data Preview</h2>
            <div class="data-preview" data-cy="data-preview">
                <table>
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div data-cy="column-info" style="margin-top: 1rem; color: var(--text-secondary);"></div>
            <div data-cy="data-quality" style="margin-top: 0.5rem;">
                <div data-cy="missing-values-warning" style="color: #fbbf24; display: none;"></div>
            </div>
        </div>

        <!-- Mobile Controls -->
        <div class="mobile-controls" data-cy="mobile-controls">
            <button onclick="toggleMobileMenu()">Menu</button>
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
            <!-- Chart Types -->
            <div class="control-panel">
                <h3>Chart Types</h3>
                <div class="chart-types" data-cy="chart-types">
                    <button data-cy="chart-option-bar" onclick="createChart('bar')">Bar Chart</button>
                    <button data-cy="chart-option-line" onclick="createChart('line')">Line Chart</button>
                    <button data-cy="chart-option-pie" onclick="createChart('pie')">Pie Chart</button>
                    <button data-cy="chart-option-scatter" onclick="createChart('scatter')">Scatter Plot</button>
                </div>
                <button data-cy="add-chart" onclick="addNewChart()" style="margin-top: 1rem;">Add New Chart</button>
            </div>

            <!-- Filters -->
            <div class="control-panel">
                <h3>Filters</h3>
                <div data-cy="filters">
                    <div class="control-group">
                        <label for="filter-category">Category:</label>
                        <select id="filter-category" data-cy="filter-category" onchange="applyFilters()">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="filter-region">Region:</label>
                        <select id="filter-region" data-cy="filter-region" onchange="applyFilters()">
                            <option value="">All</option>
                        </select>
                    </div>
                    <button data-cy="clear-filters" onclick="clearFilters()">Clear Filters</button>
                </div>
            </div>

            <!-- Sorting -->
            <div class="control-panel">
                <h3>Sort Data</h3>
                <div data-cy="sort-controls">
                    <div class="control-group">
                        <label for="sort-field">Sort by:</label>
                        <select id="sort-field" data-cy="sort-field">
                            <option value="">Select field</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="sort-direction">Direction:</label>
                        <select id="sort-direction" data-cy="sort-direction">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                    </div>
                    <button data-cy="apply-sort" onclick="applySorting()">Apply Sort</button>
                </div>
            </div>

            <!-- Export -->
            <div class="control-panel">
                <h3>Export Options</h3>
                <div data-cy="export-controls">
                    <button data-cy="export-png" onclick="exportChart('png')">Export as PNG</button>
                    <button data-cy="export-svg" onclick="exportChart('svg')">Export as SVG</button>
                    <button data-cy="export-data" onclick="exportData()">Export Data</button>
                </div>
            </div>

            <!-- Aggregation -->
            <div class="control-panel">
                <h3>Data Aggregation</h3>
                <div data-cy="aggregation-controls">
                    <div class="control-group">
                        <label for="group-by">Group by:</label>
                        <select id="group-by" data-cy="group-by">
                            <option value="">Select field</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="aggregate-function">Function:</label>
                        <select id="aggregate-function" data-cy="aggregate-function">
                            <option value="sum">Sum</option>
                            <option value="avg">Average</option>
                            <option value="count">Count</option>
                            <option value="min">Min</option>
                            <option value="max">Max</option>
                        </select>
                    </div>
                    <button data-cy="apply-aggregation" onclick="applyAggregation()">Apply</button>
                </div>
            </div>

            <!-- Customization -->
            <div class="control-panel">
                <h3>Chart Customization</h3>
                <div data-cy="chart-customization">
                    <div class="control-group">
                        <label for="chart-title-input">Chart Title:</label>
                        <input type="text" id="chart-title-input" data-cy="chart-title-input" placeholder="Enter chart title">
                    </div>
                    <div class="control-group">
                        <label for="color-picker">Chart Color:</label>
                        <input type="color" id="color-picker" data-cy="color-picker" value="#3b82f6">
                    </div>
                    <div data-cy="axis-labels">
                        <div class="control-group">
                            <label for="x-axis-label">X-Axis Label:</label>
                            <input type="text" id="x-axis-label" placeholder="X-axis label">
                        </div>
                        <div class="control-group">
                            <label for="y-axis-label">Y-Axis Label:</label>
                            <input type="text" id="y-axis-label" placeholder="Y-axis label">
                        </div>
                    </div>
                    <button data-cy="apply-customization" onclick="applyCustomization()">Apply</button>
                </div>
            </div>
        </div>

        <!-- Charts Container -->
        <div class="charts-container" id="charts-container"></div>

        <!-- Data Table Alternative -->
        <div class="control-panel">
            <button data-cy="toggle-data-table" onclick="toggleDataTable()">Show Data Table</button>
            <div data-cy="chart-data-table" style="display: none;">
                <table>
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let uploadedData = [];
        let filteredData = [];
        let charts = [];
        let currentChartIndex = 0;
        let dataTypes = {};

        // File upload handler
        document.getElementById('file-upload-input').addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                showError('File size exceeds 10MB limit');
                return;
            }

            // Check file type
            if (!file.name.endsWith('.csv')) {
                showError('Invalid file format. Please upload a CSV file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSV(e.target.result);
                } catch (error) {
                    showError('CSV format error: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(csvContent) {
            const lines = csvContent.trim().split('\n');
            if (lines.length < 2) {
                showWarning('Insufficient data for meaningful visualization');
                document.querySelectorAll('[data-cy="chart-types"] button').forEach(btn => btn.disabled = true);
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            let hasErrors = false;

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length !== headers.length) {
                    hasErrors = true;
                    continue;
                }

                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index];
                });
                data.push(row);
            }

            if (hasErrors) {
                showError('CSV format error: Inconsistent number of columns');
                return;
            }
            
            // Check if we have enough data rows (need at least 2 data points for meaningful visualization)
            if (data.length < 2) {
                showWarning('Insufficient data for meaningful visualization');
                document.querySelectorAll('[data-cy="chart-types"] button').forEach(btn => btn.disabled = true);
                return;
            }

            uploadedData = data;
            filteredData = [...data];
            analyzeDataTypes();
            showSuccess();
            displayDataPreview();
            populateControls();
            checkDataQuality();
            
            // Enable chart buttons
            document.querySelectorAll('[data-cy="chart-types"] button').forEach(btn => btn.disabled = false);
        }

        function analyzeDataTypes() {
            if (uploadedData.length === 0) return;

            const firstRow = uploadedData[0];
            dataTypes = {};

            Object.keys(firstRow).forEach(key => {
                const values = uploadedData.map(row => row[key]).filter(v => v !== '');
                
                if (values.every(v => !isNaN(v) && v !== '')) {
                    dataTypes[key] = 'Number';
                } else if (values.every(v => !isNaN(Date.parse(v)))) {
                    dataTypes[key] = 'Date';
                } else if (values.every(v => v === 'true' || v === 'false')) {
                    dataTypes[key] = 'Boolean';
                } else {
                    dataTypes[key] = 'String';
                }
            });

            displayColumnInfo();
        }

        function displayColumnInfo() {
            const infoDiv = document.querySelector('[data-cy="column-info"]');
            const typeGroups = {};

            Object.entries(dataTypes).forEach(([col, type]) => {
                if (!typeGroups[type]) typeGroups[type] = [];
                typeGroups[type].push(col);
            });

            const infoText = Object.entries(typeGroups)
                .map(([type, cols]) => `${type}: ${cols.join(', ')}`)
                .join(' | ');

            infoDiv.textContent = infoText;
        }

        function checkDataQuality() {
            const qualityDiv = document.querySelector('[data-cy="data-quality"]');
            const warningDiv = document.querySelector('[data-cy="missing-values-warning"]');
            
            let hasMissingValues = false;
            uploadedData.forEach(row => {
                Object.values(row).forEach(value => {
                    if (value === '' || value === null || value === undefined) {
                        hasMissingValues = true;
                    }
                });
            });

            if (hasMissingValues) {
                warningDiv.textContent = 'Missing values detected in dataset';
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        }

        function displayDataPreview() {
            const previewSection = document.querySelector('.data-preview-section');
            const thead = document.querySelector('[data-cy="data-preview"] thead');
            const tbody = document.querySelector('[data-cy="data-preview"] tbody');

            previewSection.style.display = 'block';
            
            // Clear existing content
            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (filteredData.length === 0) return;

            // Create headers
            const headerRow = document.createElement('tr');
            Object.keys(filteredData[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Create rows (limit to 10 for preview)
            filteredData.slice(0, 10).forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function populateControls() {
            if (uploadedData.length === 0) return;

            const headers = Object.keys(uploadedData[0]);
            
            // Populate filter dropdowns
            populateFilterOptions();
            
            // Populate sort field dropdown
            const sortField = document.getElementById('sort-field');
            sortField.innerHTML = '<option value="">Select field</option>';
            headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                sortField.appendChild(option);
            });

            // Populate group by dropdown
            const groupBy = document.getElementById('group-by');
            groupBy.innerHTML = '<option value="">Select field</option>';
            headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                groupBy.appendChild(option);
            });
        }

        function populateFilterOptions() {
            if (uploadedData.length === 0) return;

            // Get unique values for category and region fields
            const categories = new Set();
            const regions = new Set();

            uploadedData.forEach(row => {
                if (row.Category) categories.add(row.Category);
                if (row.Region) regions.add(row.Region);
            });

            // Populate category filter
            const categoryFilter = document.getElementById('filter-category');
            categoryFilter.innerHTML = '<option value="">All</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });

            // Populate region filter
            const regionFilter = document.getElementById('filter-region');
            regionFilter.innerHTML = '<option value="">All</option>';
            regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const categoryFilter = document.getElementById('filter-category').value;
            const regionFilter = document.getElementById('filter-region').value;

            filteredData = uploadedData.filter(row => {
                let match = true;
                if (categoryFilter && row.Category !== categoryFilter) match = false;
                if (regionFilter && row.Region !== regionFilter) match = false;
                return match;
            });

            displayDataPreview();
            updateAllCharts();
        }

        function clearFilters() {
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-region').value = '';
            filteredData = [...uploadedData];
            displayDataPreview();
            updateAllCharts();
        }

        function applySorting() {
            const sortField = document.getElementById('sort-field').value;
            const sortDirection = document.getElementById('sort-direction').value;

            if (!sortField) return;

            filteredData.sort((a, b) => {
                let aVal = a[sortField];
                let bVal = b[sortField];

                // Handle numeric sorting
                if (!isNaN(aVal) && !isNaN(bVal)) {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }

                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            displayDataPreview();
            updateAllCharts();
        }

        function applyAggregation() {
            const groupBy = document.getElementById('group-by').value;
            const aggregateFunction = document.getElementById('aggregate-function').value;

            if (!groupBy) return;

            const aggregated = {};
            
            filteredData.forEach(row => {
                const key = row[groupBy];
                if (!aggregated[key]) {
                    aggregated[key] = [];
                }
                aggregated[key].push(row);
            });

            // Apply aggregation function
            const result = [];
            Object.entries(aggregated).forEach(([key, rows]) => {
                const aggregatedRow = { [groupBy]: key };
                
                // Find numeric columns to aggregate
                const numericColumns = Object.keys(rows[0]).filter(col => 
                    col !== groupBy && dataTypes[col] === 'Number'
                );

                numericColumns.forEach(col => {
                    const values = rows.map(r => parseFloat(r[col]) || 0);
                    
                    switch (aggregateFunction) {
                        case 'sum':
                            aggregatedRow[col] = values.reduce((a, b) => a + b, 0);
                            break;
                        case 'avg':
                            aggregatedRow[col] = values.reduce((a, b) => a + b, 0) / values.length;
                            break;
                        case 'count':
                            aggregatedRow[col] = values.length;
                            break;
                        case 'min':
                            aggregatedRow[col] = Math.min(...values);
                            break;
                        case 'max':
                            aggregatedRow[col] = Math.max(...values);
                            break;
                    }
                });

                result.push(aggregatedRow);
            });

            filteredData = result;
            displayDataPreview();
            updateAllCharts();
        }

        function createChart(type) {
            if (filteredData.length === 0) {
                showWarning('No data available for visualization');
                return;
            }

            const chartId = `chart-${type}-${currentChartIndex}`;
            const container = createChartContainer(chartId, type);
            
            const ctx = container.querySelector('canvas').getContext('2d');
            const chartData = prepareChartData(type);
            
            const config = {
                type: type === 'scatter' ? 'scatter' : type,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false
                        }
                    }
                }
            };

            const chart = new Chart(ctx, config);
            charts.push({ id: chartId, chart: chart, type: type });
            currentChartIndex++;
        }

        function createChartContainer(chartId, type) {
            const container = document.createElement('div');
            container.className = 'chart-container';
            container.setAttribute('data-cy', 'chart-container');
            
            const wrapper = document.createElement('div');
            wrapper.className = 'chart-wrapper';
            wrapper.setAttribute('data-cy', `chart-${type}`);
            wrapper.setAttribute('aria-label', `${type} chart visualization`);
            wrapper.setAttribute('role', 'img');
            
            const canvas = document.createElement('canvas');
            canvas.id = chartId;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-chart';
            removeBtn.setAttribute('data-cy', 'remove-chart');
            removeBtn.textContent = '×';
            removeBtn.onclick = () => removeChart(chartId);
            
            wrapper.appendChild(canvas);
            container.appendChild(removeBtn);
            container.appendChild(wrapper);
            
            document.getElementById('charts-container').appendChild(container);
            
            return container;
        }

        function prepareChartData(type) {
            const headers = Object.keys(filteredData[0]);
            const labels = [];
            const datasets = [];

            // Find suitable columns for visualization
            const stringColumns = headers.filter(h => dataTypes[h] === 'String');
            const numericColumns = headers.filter(h => dataTypes[h] === 'Number');

            if (numericColumns.length === 0) {
                showWarning('No numeric data available for visualization');
                return { labels: [], datasets: [] };
            }

            // Prepare data based on chart type
            if (type === 'pie') {
                // For pie chart, use first string column as labels and first numeric column as values
                const labelColumn = stringColumns[0] || headers[0];
                const valueColumn = numericColumns[0];
                
                filteredData.forEach(row => {
                    labels.push(row[labelColumn]);
                });

                datasets.push({
                    data: filteredData.map(row => parseFloat(row[valueColumn]) || 0),
                    backgroundColor: generateColors(labels.length)
                });
            } else if (type === 'scatter') {
                // For scatter plot, use two numeric columns
                if (numericColumns.length >= 2) {
                    datasets.push({
                        label: `${numericColumns[0]} vs ${numericColumns[1]}`,
                        data: filteredData.map(row => ({
                            x: parseFloat(row[numericColumns[0]]) || 0,
                            y: parseFloat(row[numericColumns[1]]) || 0
                        })),
                        backgroundColor: '#3b82f6'
                    });
                }
            } else {
                // For bar and line charts
                const labelColumn = stringColumns[0] || headers[0];
                filteredData.forEach(row => {
                    labels.push(row[labelColumn]);
                });

                numericColumns.slice(0, 3).forEach((col, index) => {
                    datasets.push({
                        label: col,
                        data: filteredData.map(row => parseFloat(row[col]) || 0),
                        backgroundColor: generateColors(1)[0],
                        borderColor: generateColors(1)[0]
                    });
                });
            }

            return { labels, datasets };
        }

        function generateColors(count) {
            const colors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#84cc16'
            ];
            return colors.slice(0, count);
        }

        function updateAllCharts() {
            charts.forEach(({ chart, type }) => {
                const newData = prepareChartData(type);
                chart.data = newData;
                chart.update();
            });
        }

        function removeChart(chartId) {
            const index = charts.findIndex(c => c.id === chartId);
            if (index > -1) {
                charts[index].chart.destroy();
                charts.splice(index, 1);
            }
            
            const container = document.querySelector(`#${chartId}`).closest('.chart-container');
            container.remove();
        }

        function addNewChart() {
            // This function doesn't create a chart directly
            // It just prepares for the next chart creation
            // The actual chart is created when a chart type button is clicked
        }

        function applyCustomization() {
            const title = document.getElementById('chart-title-input').value;
            const color = document.getElementById('color-picker').value;
            const xLabel = document.getElementById('x-axis-label').value;
            const yLabel = document.getElementById('y-axis-label').value;

            // Apply to the most recent chart
            if (charts.length > 0) {
                const latestChart = charts[charts.length - 1];
                
                if (title) {
                    latestChart.chart.options.plugins.title = {
                        display: true,
                        text: title
                    };
                    
                    // Also add the title to the chart container for test visibility
                    const chartWrapper = document.querySelector(`[data-cy="chart-${latestChart.type}"]`);
                    if (chartWrapper) {
                        const titleDiv = document.createElement('div');
                        titleDiv.textContent = title;
                        titleDiv.style.textAlign = 'center';
                        titleDiv.style.marginBottom = '10px';
                        chartWrapper.insertBefore(titleDiv, chartWrapper.firstChild);
                    }
                }

                if (color && latestChart.chart.data.datasets.length > 0) {
                    latestChart.chart.data.datasets[0].backgroundColor = color;
                    latestChart.chart.data.datasets[0].borderColor = color;
                }

                if (xLabel || yLabel) {
                    latestChart.chart.options.scales = {
                        x: { title: { display: true, text: xLabel || '' } },
                        y: { title: { display: true, text: yLabel || '' } }
                    };
                }

                latestChart.chart.update();
            }
        }

        function exportChart(format) {
            if (charts.length === 0) {
                showWarning('No charts to export');
                return;
            }

            const latestChart = charts[charts.length - 1].chart;
            
            if (format === 'png') {
                const link = document.createElement('a');
                link.download = 'chart.png';
                link.href = latestChart.toBase64Image();
                link.click();
            } else if (format === 'svg') {
                // Chart.js doesn't support SVG export directly
                showWarning('SVG export not implemented in this demo');
            }
        }

        function exportData() {
            if (filteredData.length === 0) {
                showWarning('No data to export');
                return;
            }

            const csv = convertToCSV(filteredData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.download = 'exported-data.csv';
            link.href = URL.createObjectURL(blob);
            link.click();
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(h => row[h]).join(','))
            ].join('\n');
            
            return csv;
        }

        function toggleDataTable() {
            const table = document.querySelector('[data-cy="chart-data-table"]');
            table.style.display = table.style.display === 'none' ? 'block' : 'none';
            
            if (table.style.display === 'block' && charts.length > 0) {
                // Populate table with latest chart data
                const latestChart = charts[charts.length - 1].chart;
                const thead = table.querySelector('thead');
                const tbody = table.querySelector('tbody');
                
                thead.innerHTML = '';
                tbody.innerHTML = '';
                
                // Create headers
                const headerRow = document.createElement('tr');
                const th1 = document.createElement('th');
                th1.textContent = 'Label';
                const th2 = document.createElement('th');
                th2.textContent = 'Value';
                headerRow.appendChild(th1);
                headerRow.appendChild(th2);
                thead.appendChild(headerRow);
                
                // Create rows
                if (latestChart.data.labels) {
                    latestChart.data.labels.forEach((label, index) => {
                        const row = document.createElement('tr');
                        const td1 = document.createElement('td');
                        td1.textContent = label;
                        const td2 = document.createElement('td');
                        td2.textContent = latestChart.data.datasets[0].data[index];
                        row.appendChild(td1);
                        row.appendChild(td2);
                        tbody.appendChild(row);
                    });
                }
            }
        }

        function toggleMobileMenu() {
            const controls = document.querySelector('.controls-section');
            controls.style.display = controls.style.display === 'none' ? 'grid' : 'none';
        }

        function showSuccess() {
            const successDiv = document.querySelector('[data-cy="upload-success"]');
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function showError(message) {
            const errorDiv = document.querySelector('[data-cy="error-message"]');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showWarning(message) {
            const warningDiv = document.querySelector('[data-cy="warning-message"]');
            warningDiv.textContent = message;
            warningDiv.style.display = 'block';
            setTimeout(() => {
                warningDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>